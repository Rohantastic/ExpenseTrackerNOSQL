<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Expense</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

</head>

<body>
    <form onsubmit="addNewExpenses(event)">

        <label for="expense">Add Expense</label>
        <input type="number" name="expense" required>

        <label for="description">Add description</label>
        <input type="text" name="description" required>

        <label for="category">Category</label>
        <select name="category">
            <option value="1">Fuel</option>
            <option value="2">Medicine</option>
            <option value="3">Groceries</option>
            <option value="4">Other</option>
        </select>
        <button>Add</button>
    </form>
    <div id="message"></div>
    <button id="razorPayButton">Buy Premium</button>
    <button id="downloadExpenseButton" style="visibility: hidden;">Download</button>
    <p id="premiumUserMessage"></p>
    <hr>
    <h1 id="nameOfUser"></h1>
    <div id="manifest"></div>
    <div id="LeaderBoardText"></div>
    <ul id="leaderboard"></ul>
    <script>

        var token = localStorage.getItem('token');


        function parseJwt(token) {
            var base64Url = token.split('.')[1];
            var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function (c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));

            return JSON.parse(jsonPayload);
        }




        document.addEventListener('DOMContentLoaded', async () => {
            try {

                token = localStorage.getItem('token');

                const decodedToken = parseJwt(token);


                const isTrue = decodedToken.ispremiumuser;

                if (isTrue === true) {
                    localStorage.setItem('isPremiumUser', 'true');
                } else {
                    localStorage.setItem('isPremiumUser', 'false');
                }

                const isPremiumUser = localStorage.getItem('isPremiumUser');

                if (isPremiumUser === 'true') {
                    document.getElementById('premiumUserMessage').innerHTML = '<p style="color: gold;">Premium User</p>';
                    document.getElementById('razorPayButton').style.display = 'none';
                    showLeaderboard();
                    download(); //will only be visible for premium user

                }
            } catch (error) {
                console.error('Error while checking premium status:', error);
            }
        });


        function showLeaderboard() {
            const inputElement = document.createElement("input")
            inputElement.type = "button"
            inputElement.value = 'Show Leaderboard'
            inputElement.onclick = async () => {
                const token = localStorage.getItem('token')
                const userLeaderBoardArray = await axios.get('http://localhost:3000/premium/leaderboard', { headers: { "Authorization": token } })
                //console.log(userLeaderBoardArray)

                var leaderboardElem = document.getElementById('leaderboard')
                leaderboardElem.innerHTML = '<h1> Leader Board </h1>';
                //leaderboardElem.innerHTML += '<h1> Leader Board </<h1>'
                userLeaderBoardArray.data.forEach((userDetails) => {
                    leaderboardElem.innerHTML += `<li>Name - ${userDetails.name} Total Expense - ${userDetails.ExpenseAmount || 0} </li>`
                })
            }
            const messageElement = document.getElementById("message");
            messageElement.innerHTML = '';
            messageElement.appendChild(inputElement);
        };


        //download button to download expenses file
        function download(){
            const downloadButton = document.getElementById('downloadExpenseButton');
            downloadButton.style.visibility='visible';
            downloadButton.addEventListener('click',async (e)=>{
                e.preventDefault();

            });
        }




        function addNewExpenses(e) {

            e.preventDefault();
            const expenseDetails = {
                expense: e.target.expense.value,
                description: e.target.description.value,
                category: e.target.category.value,
            }
            //sending post call to store details in database
            axios.post('http://localhost:3000/expense/addExpense', expenseDetails, { headers: { "Authorization": token } }).then((response) => {
                if (response.status === 201) {
                    fetchDataFromDatabase(); //fetching the data from database (retrieving).
                    
                } else {
                    console.log("err");
                }
            });
        };

        function fetchDataFromDatabase() { //function to get/fetch data from database
            axios.get('http://localhost:3000/expense/getExpenses', { headers: { "Authorization": token } }).then((response) => {
                showDataFromDatabase(response.data.expenses); //sending to function to display the data, check controller - how json is sending data to html
            }).catch(err => console.log(err));
        }

        function showDataFromDatabase(expense) { //function to display data
            const manifest = document.getElementById('manifest');
            manifest.innerHTML = '';
            expense.forEach((element) => {
                let string = `<li> Expense: ${element.expense} || Category: ${element.category} || Description: ${element.description} || <button onclick="deleteExpense(${element.id})"> Delete </button> </li>`;
                manifest.innerHTML += string;
            });
        }

        async function deleteExpense(id) {
            const response = await axios.delete(`http://localhost:3000/expense/deleteExpense/${id}`, { headers: { "Authorization": token } });
            if (response.status === 204) {
                fetchDataFromDatabase();
                console.log("Deleted");
            } else {
                const errorDiv = document.getElementsByClassName('errorDiv');
                errorDiv.innerHTML = ` <p style="color:red;"> Error Deleting, User UnAuthorized!! </p> `;
            }
        }


        //buy premium functionality
        document.getElementById('razorPayButton').addEventListener('click', async (e) => {
            e.preventDefault();
            const token = localStorage.getItem('token');
            const response = await axios.get('http://localhost:3000/purchase/premiummembership', { headers: { "Authorization": token } });
            var options = {
                "key": response.data.key_id,
                "order_id": response.data.order.id,
                "handler": async function (response) {
                    const responseOfAxiosPost = await axios.post('http://localhost:3000/purchase/updatetransactionstatus', {
                        order_id: options.order_id,
                        payment_id: response.razorpay_payment_id
                    }, { headers: { "Authorization": token } });
                    //console.log(">>>> response.data.token from axios.get to premiummembership",response.data.token);
                    alert("You are a premium user now");
                    document.getElementById('premiumUserMessage').innerHTML = `<p style="color:gold;">Premium User</p>`;
                    document.getElementById('razorPayButton').style.visibility = 'hidden';
                    

                    localStorage.setItem('token', responseOfAxiosPost.data.token)


                },

            };

            const rzp1 = new Razorpay(options);
            rzp1.open(); //this will open our page from razorpays page
            //e.preventDefault();
            rzp1.on('payment.failed', function (response) {
                console.log(response);
                alert('something went wrong');
            });

        });



        fetchDataFromDatabase();//calling function (function call).
    </script>
</body>

</html>