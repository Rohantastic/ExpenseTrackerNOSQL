<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

</head>

<body>
    <form onsubmit="addNewExpenses(event)">

        <label for="expense">Add Expense</label>
        <input type="number" name="expense" required>

        <label for="description">Add description</label>
        <input type="text" name="description" required>

        <label for="category">Category</label>
        <select name="category">
            <option value="1">Fuel</option>
        </select>
        <button>Add</button>
    </form>
    <button id="razorPayButton">Premium</button>
    <hr>
    <h1 id="nameOfUser"></h1>
    <div id="manifest">

    </div>
    <script>
        const token = localStorage.getItem('token');
        function addNewExpenses(e) {
            
            e.preventDefault();
            const expenseDetails = {
                expense: e.target.expense.value,
                description: e.target.description.value,
                category: e.target.category.value,
            }
            //sending post call to store details in database
            axios.post('http://localhost:3000/expense/addExpense',expenseDetails, { headers: {"Authorization":token} }).then((response) => {
                if (response.status === 201) {
                    fetchDataFromDatabase(); //fetching the data from database (retrieving).
                } else {
                    console.log("err");
                }
            });
        };
        
        function fetchDataFromDatabase() { //function to get/fetch data from database
            axios.get('http://localhost:3000/expense/getExpenses',{ headers: {"Authorization":token}}).then((response) => {
                showDataFromDatabase(response.data.expenses); //sending to function to display the data, check controller - how json is sending data to html
            }).catch(err => console.log(err));
        }

        function showDataFromDatabase(expense) { //function to display data
            const manifest = document.getElementById('manifest');
            manifest.innerHTML = '';
            expense.forEach((element) => {
                let string = `<li> Expense: ${element.expense} || Category: ${element.category} || Description: ${element.description} || <button onclick="deleteExpense(${element.id})"> Delete </button> </li>`;
                manifest.innerHTML += string;
            });
        }

        async function deleteExpense(id) {
            const response = await axios.delete(`http://localhost:3000/expense/deleteExpense/${id}`,{ headers: {"Authorization":token}});
            if (response.status === 204) {
                fetchDataFromDatabase();
                console.log("Deleted");
            }else{
                const errorDiv = document.getElementsByClassName('errorDiv');
                errorDiv.innerHTML = ` <p style="color:red;"> Error Deleting, User UnAuthorized!! </p> `;
            }
        }


        //buy premium functionality
        document.getElementById('razorPayButton').addEventListener('click', async (e)=>{
            e.preventDefault();
            const token = localStorage.getItem('token');
            const response = await axios.get('http://localhost:3000/purchase/premiummembership',{ headers: {"Authorization":token}});
            var options = {
                "key" : response.data.key_id,
                "order_id" : response.data.order.id,
                "handler" : async function (response){
                    await axios.post('http://localhost:3000/purchase/updatetransactionstatus',{
                        order_id : options.order_id,
                        payment_id : response.razorpay_payment_id
                    },{headers : {"Authorization": token}});

                    alert("You are a premium user now");
                },
                
            };

            const rzp1 = new Razorpay(options);
            rzp1.open();
            //e.preventDefault();
            rzp1.on('payment.failed', function(response){
                console.log(response);
                alert('something went wrong');
            });

        });



        fetchDataFromDatabase();//calling function (function call).
    </script>
</body>

</html>